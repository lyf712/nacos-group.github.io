{
  "filename": "use-nacos-with-istio.md",
  "__html": "<h1>Istio 指南</h1>\n<p>支持了 xDS 协议中的 CDS、EDS 服务，并为 EDS 以及 MCP 实现了增量推送。用户可以使用 Envoy 或其他支持 xDS 协议的客户端与 Nacos 进行对接，实现服务发现功能。</p>\n<h2>配置</h2>\n<h3>服务端</h3>\n<p>对于发行包，修改 <code>nacos/conf/application.properties</code> 中的 <code>nacos.istio.mcp.server.enabled</code> 为 true；</p>\n<p>对于源码，修改 <code>nacos/distribution/conf/application.properties</code> 中的 <code>nacos.istio.mcp.server.enabled</code> 为 true 。</p>\n<p>若要使用 MCP 增量服务，除上述配置需修改外，还需修改 <code>nacos/istio/misc/IstioConfig</code> 中的 <code>nacos.istio.server.full</code> 为 false。</p>\n<h3>客户端</h3>\n<p>关于客户端，下面示例中使用的是 Envoy，可直接下载 Envoy 或创建镜像并将下述配置文件进行挂载即可。</p>\n<p><strong>Config</strong>：其中使用的端口号根据需求可自行更改</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">node:</span>\n  <span class=\"hljs-attr\">cluster:</span> <span class=\"hljs-string\">test-cluster</span>\n  <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">test-idn</span>\n\n<span class=\"hljs-attr\">admin:</span>\n  <span class=\"hljs-attr\">address:</span>\n    <span class=\"hljs-attr\">socket_address:</span> <span class=\"hljs-string\">{</span> <span class=\"hljs-attr\">address:</span> <span class=\"hljs-number\">0.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-string\">,</span> <span class=\"hljs-attr\">port_value:</span> <span class=\"hljs-number\">15000</span> <span class=\"hljs-string\">}</span>\n\n<span class=\"hljs-attr\">dynamic_resources:</span>\n  <span class=\"hljs-attr\">ads_config:</span>\n    <span class=\"hljs-attr\">api_type:</span> <span class=\"hljs-string\">GRPC</span>\n    <span class=\"hljs-attr\">transport_api_version:</span> <span class=\"hljs-string\">V3</span>\n    <span class=\"hljs-attr\">grpc_services:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">envoy_grpc:</span>\n        <span class=\"hljs-attr\">cluster_name:</span> <span class=\"hljs-string\">nacos_xds</span>\n  <span class=\"hljs-attr\">cds_config:</span>\n    <span class=\"hljs-attr\">ads:</span> <span class=\"hljs-string\">{}</span>\n  <span class=\"hljs-attr\">lds_config:</span>\n    <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">/etc/envoy/lds.yaml</span>\n  <span class=\"hljs-comment\"># ads: {}</span>\n\n<span class=\"hljs-attr\">static_resources:</span>\n  <span class=\"hljs-attr\">clusters:</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">type:</span> <span class=\"hljs-string\">STATIC</span>\n    <span class=\"hljs-attr\">connect_timeout:</span> <span class=\"hljs-string\">1s</span>\n    <span class=\"hljs-attr\">typed_extension_protocol_options:</span>\n      <span class=\"hljs-attr\">envoy.extensions.upstreams.http.v3.HttpProtocolOptions:</span>\n        <span class=\"hljs-string\">\"@type\"</span><span class=\"hljs-string\">:</span> <span class=\"hljs-string\">type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions</span>\n        <span class=\"hljs-attr\">explicit_http_config:</span>\n          <span class=\"hljs-attr\">http2_protocol_options:</span> <span class=\"hljs-string\">{}</span>\n    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">nacos_xds</span> \n    <span class=\"hljs-attr\">load_assignment:</span>\n      <span class=\"hljs-attr\">cluster_name:</span> <span class=\"hljs-string\">nacos_xds</span> \n      <span class=\"hljs-attr\">endpoints:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">lb_endpoints:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">endpoint:</span>\n            <span class=\"hljs-attr\">address:</span>\n              <span class=\"hljs-attr\">socket_address:</span>\n                <span class=\"hljs-attr\">address:</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span> \n                <span class=\"hljs-attr\">port_value:</span> <span class=\"hljs-number\">18848</span>\n</code></pre>\n<p><strong>lds</strong>：对于监听的服务获取 CDS 后会主动向服务端获取 EDS，监听的服务可自行更改</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">resources:</span>\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">\"@type\"</span><span class=\"hljs-string\">:</span> <span class=\"hljs-string\">type.googleapis.com/envoy.config.listener.v3.Listener</span>\n  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">listener_0</span>\n  <span class=\"hljs-attr\">address:</span>\n    <span class=\"hljs-attr\">socket_address:</span> <span class=\"hljs-string\">{</span> <span class=\"hljs-attr\">address:</span> <span class=\"hljs-number\">0.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-string\">,</span> <span class=\"hljs-attr\">port_value:</span> <span class=\"hljs-number\">80</span> <span class=\"hljs-string\">}</span>\n  <span class=\"hljs-comment\"># listener_filters:</span>\n  <span class=\"hljs-comment\"># - name: \"envoy.filters.listener.tls_inspector\"</span>\n  <span class=\"hljs-attr\">filter_chains:</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">filters:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">envoy.filters.network.http_connection_manager</span>\n      <span class=\"hljs-attr\">typed_config:</span>\n        <span class=\"hljs-string\">\"@type\"</span><span class=\"hljs-string\">:</span> <span class=\"hljs-string\">type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager</span>\n        <span class=\"hljs-attr\">stat_prefix:</span> <span class=\"hljs-string\">ingress_http</span>\n        <span class=\"hljs-attr\">access_log:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">envoy.access_loggers.stdout</span>\n          <span class=\"hljs-attr\">typed_config:</span>\n            <span class=\"hljs-string\">\"@type\"</span><span class=\"hljs-string\">:</span> <span class=\"hljs-string\">type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog</span>\n        <span class=\"hljs-attr\">codec_type:</span> <span class=\"hljs-string\">AUTO</span>\n        <span class=\"hljs-attr\">route_config:</span>\n          <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">local_route</span>\n          <span class=\"hljs-attr\">virtual_hosts:</span>\n          <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">local_service</span>\n            <span class=\"hljs-attr\">domains:</span> <span class=\"hljs-string\">[\"*\"]</span>\n            <span class=\"hljs-attr\">routes:</span>\n            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">match:</span> <span class=\"hljs-string\">{</span> <span class=\"hljs-attr\">prefix:</span> <span class=\"hljs-string\">\"/\"</span> <span class=\"hljs-string\">}</span>\n              <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">test</span>\n              <span class=\"hljs-attr\">route:</span>\n                <span class=\"hljs-attr\">cluster:</span> <span class=\"hljs-string\">outbound|8071||service-provider.DEFAULT-GROUP.e77d7925-1c90-4fa9-93cb-83153a099636.nacos</span>\n        <span class=\"hljs-attr\">http_filters:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">envoy.filters.http.router</span>\n</code></pre>\n<h2>运行</h2>\n<p>注：同一服务下的各个实例使用的协议需一致，EDS 默认使用增量推送。</p>\n<ol>\n<li>\n<p>部署 Nacos，<a href=\"https://nacos.io/zh-cn/docs/quick-start.html\">部署参考</a>；</p>\n</li>\n<li>\n<p>按上述要求修改配置；</p>\n</li>\n<li>\n<p>启动服务器，详细的启动命令可在上述部署参考中查看；</p>\n<pre><code class=\"language-bash\">bash startup.sh -m standalone -p embedded\n</code></pre>\n</li>\n<li>\n<p>启动客户端。</p>\n<pre><code class=\"language-bash\">docker start envoy\n</code></pre>\n</li>\n</ol>\n<h2>CDS 示例</h2>\n<p>注：日志在 nacos/logs/istio-main.log 查看</p>\n<p>示例中注册的服务配置如下，<a href=\"https://github.com/nacos-group/nacos-examples/tree/master/nacos-spring-cloud-example/nacos-spring-cloud-discovery-example\">示例参考</a>。</p>\n<pre><code class=\"language-properties\"><span class=\"hljs-meta\">server.port</span>=<span class=\"hljs-string\">8071</span>\n<span class=\"hljs-meta\">spring.application.name</span>=<span class=\"hljs-string\">service-provider</span>\n<span class=\"hljs-meta\">spring.cloud.nacos.discovery.namespace</span>=<span class=\"hljs-string\">e77d7925-1c90-4fa9-93cb-83153a099636</span>\n<span class=\"hljs-meta\">spring.cloud.nacos.discovery.server-addr</span>=<span class=\"hljs-string\">127.0.0.1:8848</span>\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2022/png/28990648/1666247341241-4e9b2dde-55c7-43ae-af1e-dc081565ab72.png\" alt=\"CDS\"></p>\n<h2>EDS 示例</h2>\n<p>服务配置如上</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2022/png/28990648/1666247341176-fe312687-6488-41c2-bdd1-346d7a344bd2.png\" alt=\"EDS\"></p>\n<h2>全量 CDS 示例</h2>\n<p>现注册两个服务，其配置分别如下：</p>\n<pre><code class=\"language-properties\"><span class=\"hljs-comment\">#service-provider</span>\n<span class=\"hljs-meta\">server.port</span>=<span class=\"hljs-string\">8071</span>\n<span class=\"hljs-meta\">spring.application.name</span>=<span class=\"hljs-string\">service-provider</span>\n<span class=\"hljs-meta\">spring.cloud.nacos.discovery.namespace</span>=<span class=\"hljs-string\">e77d7925-1c90-4fa9-93cb-83153a099636</span>\n<span class=\"hljs-meta\">spring.cloud.nacos.discovery.server-addr</span>=<span class=\"hljs-string\">127.0.0.1:8848</span>\n<span class=\"hljs-comment\">\n#service-consumer</span>\n<span class=\"hljs-meta\">server.port</span>=<span class=\"hljs-string\">8080</span>\n<span class=\"hljs-meta\">spring.application.name</span>=<span class=\"hljs-string\">service-consumer</span>\n<span class=\"hljs-meta\">spring.cloud.nacos.discovery.server-addr</span>=<span class=\"hljs-string\">127.0.0.1:8848</span>\n</code></pre>\n<p>在控制台仅修改 service-consumer 服务配置，推送如下：</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2022/png/28990648/1666247341233-bc35de56-5653-4d5f-a510-819180dfe7f0.png\" alt=\"Full CDS\"></p>\n<h2>增量 EDS 示例</h2>\n<p>在控制台仅修改 service-consumer 实例配置，推送如下：</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2022/png/28990648/1666247341234-aa195810-c76d-4ff5-977a-55626775e697.png\" alt=\"Incremental EDS\"></p>\n",
  "link": "/zh-cn/docs/v2/ecology/use-nacos-with-istio.html",
  "meta": {
    "title": "Nacos 融合Istio 下发xDS协议",
    "keywords": "Istio,xDs,Envoy",
    "description": "Nacos 融合Istio 下发xDS协议"
  }
}