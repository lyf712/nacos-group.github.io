{
  "filename": "use-nacos-with-istio.md",
  "__html": "<h1>Istio Guide</h1>\n<p>It supports CDS and EDS in xDS protocol, and realizes incremental push for EDS and MCP. Users can use Envoy or other XDS protocol-enabled clients to dock with Nacos for service discovery.</p>\n<h2>Configuration</h2>\n<h3>Server</h3>\n<p>For distribution packages:</p>\n<p>modify <code>nacos.istio.mcp.server.enabled</code> in <code>nacos/conf/application.properties</code> to true.</p>\n<p>For source code:</p>\n<p>modify <code>nacos.istio.mcp.server.enabled</code>  in <code>nacos/distribution/conf/application.properties</code> to true.</p>\n<p>For incremental MCP:</p>\n<p>modify <code>nacos.istio.server.full</code> in  <code>nacos/istio/misc/IstioConfig</code>  to false in addition to the above configuration.</p>\n<h3>Client</h3>\n<p>In the following example, using Envoy, you can download the Envoy directly or create a mirror and mount the following configuration file.</p>\n<p><strong>Config</strong> : the port number used can be changed on demand.</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">node:</span>\n  <span class=\"hljs-attr\">cluster:</span> <span class=\"hljs-string\">test-cluster</span>\n  <span class=\"hljs-attr\">id:</span> <span class=\"hljs-string\">test-idn</span>\n\n<span class=\"hljs-attr\">admin:</span>\n  <span class=\"hljs-attr\">address:</span>\n    <span class=\"hljs-attr\">socket_address:</span> <span class=\"hljs-string\">{</span> <span class=\"hljs-attr\">address:</span> <span class=\"hljs-number\">0.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-string\">,</span> <span class=\"hljs-attr\">port_value:</span> <span class=\"hljs-number\">15000</span> <span class=\"hljs-string\">}</span>\n\n<span class=\"hljs-attr\">dynamic_resources:</span>\n  <span class=\"hljs-attr\">ads_config:</span>\n    <span class=\"hljs-attr\">api_type:</span> <span class=\"hljs-string\">GRPC</span>\n    <span class=\"hljs-attr\">transport_api_version:</span> <span class=\"hljs-string\">V3</span>\n    <span class=\"hljs-attr\">grpc_services:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">envoy_grpc:</span>\n        <span class=\"hljs-attr\">cluster_name:</span> <span class=\"hljs-string\">nacos_xds</span>\n  <span class=\"hljs-attr\">cds_config:</span>\n    <span class=\"hljs-attr\">ads:</span> <span class=\"hljs-string\">{}</span>\n  <span class=\"hljs-attr\">lds_config:</span>\n    <span class=\"hljs-attr\">path:</span> <span class=\"hljs-string\">/etc/envoy/lds.yaml</span>\n  <span class=\"hljs-comment\"># ads: {}</span>\n\n<span class=\"hljs-attr\">static_resources:</span>\n  <span class=\"hljs-attr\">clusters:</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">type:</span> <span class=\"hljs-string\">STATIC</span>\n    <span class=\"hljs-attr\">connect_timeout:</span> <span class=\"hljs-string\">1s</span>\n    <span class=\"hljs-attr\">typed_extension_protocol_options:</span>\n      <span class=\"hljs-attr\">envoy.extensions.upstreams.http.v3.HttpProtocolOptions:</span>\n        <span class=\"hljs-string\">\"@type\"</span><span class=\"hljs-string\">:</span> <span class=\"hljs-string\">type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions</span>\n        <span class=\"hljs-attr\">explicit_http_config:</span>\n          <span class=\"hljs-attr\">http2_protocol_options:</span> <span class=\"hljs-string\">{}</span>\n    <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">nacos_xds</span> \n    <span class=\"hljs-attr\">load_assignment:</span>\n      <span class=\"hljs-attr\">cluster_name:</span> <span class=\"hljs-string\">nacos_xds</span> \n      <span class=\"hljs-attr\">endpoints:</span>\n      <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">lb_endpoints:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">endpoint:</span>\n            <span class=\"hljs-attr\">address:</span>\n              <span class=\"hljs-attr\">socket_address:</span>\n                <span class=\"hljs-attr\">address:</span> <span class=\"hljs-number\">127.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.1</span> \n                <span class=\"hljs-attr\">port_value:</span> <span class=\"hljs-number\">18848</span>\n</code></pre>\n<p><strong>lds</strong> : when Envoy acquires a listening service, it automatically acquires EDS from the server. The listening service can change as needed.</p>\n<pre><code class=\"language-yaml\"><span class=\"hljs-attr\">resources:</span>\n<span class=\"hljs-bullet\">-</span> <span class=\"hljs-string\">\"@type\"</span><span class=\"hljs-string\">:</span> <span class=\"hljs-string\">type.googleapis.com/envoy.config.listener.v3.Listener</span>\n  <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">listener_0</span>\n  <span class=\"hljs-attr\">address:</span>\n    <span class=\"hljs-attr\">socket_address:</span> <span class=\"hljs-string\">{</span> <span class=\"hljs-attr\">address:</span> <span class=\"hljs-number\">0.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-number\">.0</span><span class=\"hljs-string\">,</span> <span class=\"hljs-attr\">port_value:</span> <span class=\"hljs-number\">80</span> <span class=\"hljs-string\">}</span>\n  <span class=\"hljs-comment\"># listener_filters:</span>\n  <span class=\"hljs-comment\"># - name: \"envoy.filters.listener.tls_inspector\"</span>\n  <span class=\"hljs-attr\">filter_chains:</span>\n  <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">filters:</span>\n    <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">envoy.filters.network.http_connection_manager</span>\n      <span class=\"hljs-attr\">typed_config:</span>\n        <span class=\"hljs-string\">\"@type\"</span><span class=\"hljs-string\">:</span> <span class=\"hljs-string\">type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager</span>\n        <span class=\"hljs-attr\">stat_prefix:</span> <span class=\"hljs-string\">ingress_http</span>\n        <span class=\"hljs-attr\">access_log:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">envoy.access_loggers.stdout</span>\n          <span class=\"hljs-attr\">typed_config:</span>\n            <span class=\"hljs-string\">\"@type\"</span><span class=\"hljs-string\">:</span> <span class=\"hljs-string\">type.googleapis.com/envoy.extensions.access_loggers.stream.v3.StdoutAccessLog</span>\n        <span class=\"hljs-attr\">codec_type:</span> <span class=\"hljs-string\">AUTO</span>\n        <span class=\"hljs-attr\">route_config:</span>\n          <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">local_route</span>\n          <span class=\"hljs-attr\">virtual_hosts:</span>\n          <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">local_service</span>\n            <span class=\"hljs-attr\">domains:</span> <span class=\"hljs-string\">[\"*\"]</span>\n            <span class=\"hljs-attr\">routes:</span>\n            <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">match:</span> <span class=\"hljs-string\">{</span> <span class=\"hljs-attr\">prefix:</span> <span class=\"hljs-string\">\"/\"</span> <span class=\"hljs-string\">}</span>\n              <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">test</span>\n              <span class=\"hljs-attr\">route:</span>\n                <span class=\"hljs-attr\">cluster:</span> <span class=\"hljs-string\">outbound|8071||service-provider.DEFAULT-GROUP.e77d7925-1c90-4fa9-93cb-83153a099636.nacos</span>\n        <span class=\"hljs-attr\">http_filters:</span>\n        <span class=\"hljs-bullet\">-</span> <span class=\"hljs-attr\">name:</span> <span class=\"hljs-string\">envoy.filters.http.router</span>\n</code></pre>\n<h2>RUN</h2>\n<p>Note: each instance of the same service should use the same protocol, EDS default to use incremental push.</p>\n<ol>\n<li>\n<p>Deploy Nacos, <a href=\"https://nacos.io/zh-cn/docs/quick-start.html\"> deployment reference </a>;</p>\n</li>\n<li>\n<p>Modify the configuration in accordance with the above requirements;</p>\n</li>\n<li>\n<p>Start the server, the detailed start command can be seen in the above deployment reference;</p>\n<pre><code class=\"language-bash\">bash startup.sh -m standalone -p embedded\n</code></pre>\n</li>\n<li>\n<p>Start the client.</p>\n<pre><code class=\"language-bash\">docker start envoy\n</code></pre>\n</li>\n</ol>\n<h2>CDS Example</h2>\n<p>Note: The logs are viewed in nacos/logs/istio-main.log</p>\n<p>The service configuration registered in the example is as follows, <a href=\"https://github.com/nacos-group/nacos-examples/tree/master/nacos-spring-cloud-example/nacos-spring-cloud-discovery-example\"> example reference </a>.</p>\n<pre><code class=\"language-properties\"><span class=\"hljs-meta\">server.port</span>=<span class=\"hljs-string\">8071</span>\n<span class=\"hljs-meta\">spring.application.name</span>=<span class=\"hljs-string\">service-provider</span>\n<span class=\"hljs-meta\">spring.cloud.nacos.discovery.namespace</span>=<span class=\"hljs-string\">e77d7925-1c90-4fa9-93cb-83153a099636</span>\n<span class=\"hljs-meta\">spring.cloud.nacos.discovery.server-addr</span>=<span class=\"hljs-string\">127.0.0.1:8848</span>\n</code></pre>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2022/png/28990648/1666247341241-4e9b2dde-55c7-43ae-af1e-dc081565ab72.png\" alt=\"CDS\"></p>\n<h2>EDS Example</h2>\n<p>The service is configured as above.</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2022/png/28990648/1666247341176-fe312687-6488-41c2-bdd1-346d7a344bd2.png\" alt=\"EDS\"></p>\n<h2>Full CDS Example</h2>\n<p>The services are registered with the following configurations:</p>\n<pre><code class=\"language-properties\"><span class=\"hljs-comment\">#service-provider</span>\n<span class=\"hljs-meta\">server.port</span>=<span class=\"hljs-string\">8071</span>\n<span class=\"hljs-meta\">spring.application.name</span>=<span class=\"hljs-string\">service-provider</span>\n<span class=\"hljs-meta\">spring.cloud.nacos.discovery.namespace</span>=<span class=\"hljs-string\">e77d7925-1c90-4fa9-93cb-83153a099636</span>\n<span class=\"hljs-meta\">spring.cloud.nacos.discovery.server-addr</span>=<span class=\"hljs-string\">127.0.0.1:8848</span>\n<span class=\"hljs-comment\">\n#service-consumer</span>\n<span class=\"hljs-meta\">server.port</span>=<span class=\"hljs-string\">8080</span>\n<span class=\"hljs-meta\">spring.application.name</span>=<span class=\"hljs-string\">service-consumer</span>\n<span class=\"hljs-meta\">spring.cloud.nacos.discovery.server-addr</span>=<span class=\"hljs-string\">127.0.0.1:8848</span>\n</code></pre>\n<p>In the console, modify only the service-consumer service configuration, push as follows:</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2022/png/28990648/1666247341233-bc35de56-5653-4d5f-a510-819180dfe7f0.png\" alt=\"Full CDS\"></p>\n<h2>Incremental EDS Example</h2>\n<p>In the console, modify only the service-consumer instance configuration, push as follows:</p>\n<p><img src=\"https://cdn.nlark.com/yuque/0/2022/png/28990648/1666247341234-aa195810-c76d-4ff5-977a-55626775e697.png\" alt=\"Incremental EDS\"></p>\n",
  "link": "/en-us/docs/v2/ecology/use-nacos-with-istio.html",
  "meta": {
    "title": "Nacos push xDS with Istio",
    "keywords": "Istio,xDs,Envoy",
    "description": "Nacos push xDS with Istio"
  }
}